<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bicep Generation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        h2 {
            color: #333;
        }
        .pass {
            color: #4CAF50;
            font-weight: bold;
        }
        .fail {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🔧 Bicep Generation Test - Microsoft.Resources/deployments Fix</h1>
    
    <div class="test-section">
        <h2>Test Schema (Microsoft.Resources/deployments)</h2>
        <pre id="schemaDisplay"></pre>
    </div>
    
    <div class="test-section">
        <button onclick="runTest()">Run Test</button>
        <button onclick="runComparisonTest()">Compare Before/After</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Generated Bicep Template</h2>
        <pre id="bicepOutput"></pre>
    </div>

    <script>
        // Test schema for Microsoft.Resources/deployments
        const testSchema = {
            "$schema": "http://json-schema.org/draft-07/schema#",
            "type": "object",
            "title": "Azure Deployment Template Schema",
            "description": "JSON Schema for Microsoft.Resources/deployments",
            "properties": {
                "apiVersion": {
                    "type": "string",
                    "const": "2022-01-01",
                    "description": "API version for the deployment resource"
                },
                "type": {
                    "type": "string",
                    "const": "Microsoft.Resources/deployments",
                    "description": "Resource type"
                },
                "name": {
                    "type": "string",
                    "description": "Name of the deployment",
                    "minLength": 1,
                    "maxLength": 64
                },
                "properties": {
                    "type": "object",
                    "description": "Deployment properties"
                }
            },
            "required": ["apiVersion", "type", "name", "properties"]
        };

        // Display schema
        document.getElementById('schemaDisplay').textContent = JSON.stringify(testSchema, null, 2);

        // Helper functions (copied from script.js)
        function resourceSupportsLocationAndTags(resourceType, targetScope = 'resourceGroup') {
            if (resourceType === 'Microsoft.Resources/deployments' && targetScope === 'resourceGroup') {
                return false;
            }
            
            const resourcesWithoutLocation = [
                'Microsoft.Authorization/policyAssignments',
                'Microsoft.Authorization/roleAssignments'
            ];
            
            return !resourcesWithoutLocation.includes(resourceType);
        }

        function getResourceNameFromType(resourceType) {
            const parts = resourceType.split('/');
            const resourceTypeName = parts[parts.length - 1];
            return resourceTypeName.charAt(0).toLowerCase() + resourceTypeName.slice(1);
        }

        function getLatestApiVersion(schema) {
            return schema.properties?.apiVersion?.const || '2022-01-01';
        }

        function generateAdvancedParameters(schema, resourceType, targetScope = 'resourceGroup') {
            const supportsLocationAndTags = resourceSupportsLocationAndTags(resourceType, targetScope);
            
            let params = `// === PARAMETERS ===

@description('The name of the resource')
@minLength(1)
@maxLength(80)
param resourceName string

`;

            if (supportsLocationAndTags) {
                params += `@description('The location for the resource')
param location string = resourceGroup().location

`;
            }

            params += `@description('Environment name (e.g., dev, test, prod)')
@allowed(['dev', 'test', 'staging', 'prod'])
param environment string = 'dev'

`;

            if (supportsLocationAndTags) {
                params += `@description('Resource tags')
param tags object = {
  Environment: environment
  CreatedBy: 'Bicep Schema Builder'
  CreatedDate: utcNow('yyyy-MM-dd')
}

`;
            }

            return params;
        }

        function generateVariables(schema, resourceType, targetScope = 'resourceGroup') {
            const supportsLocationAndTags = resourceSupportsLocationAndTags(resourceType, targetScope);
            
            let variables = `// === VARIABLES ===

var resourceNameFormatted = toLower(replace(resourceName, ' ', '-'))
`;

            if (supportsLocationAndTags) {
                variables += `var commonTags = union(tags, {
  ResourceType: '${resourceType}'
  DeployedBy: 'Bicep Schema Builder'
})

`;
            }

            return variables;
        }

        function generateDetailedResource(schema, resourceType, cleanResourceName) {
            let resource = `// === RESOURCE DEFINITION ===

`;

            if (resourceType === 'Microsoft.Resources/deployments') {
                resource += `resource ${cleanResourceName} '${resourceType}@${getLatestApiVersion(schema)}' = {
  name: resourceNameFormatted
  properties: {
    mode: 'Incremental'
    template: {
      '$schema': 'https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#'
      contentVersion: '1.0.0.0'
      resources: []
    }
  }
}

`;
            }

            return resource;
        }

        function generateAdvancedOutputs(schema, cleanResourceName, targetScope = 'resourceGroup') {
            const resourceType = schema.properties?.type?.const;
            const supportsLocationAndTags = resourceSupportsLocationAndTags(resourceType, targetScope);
            
            let outputs = `// === OUTPUTS ===

@description('Resource ID of the created resource')
output resourceId string = ${cleanResourceName}.id

@description('Name of the created resource')
output resourceName string = ${cleanResourceName}.name

`;

            if (supportsLocationAndTags) {
                outputs += `@description('Location of the created resource')
output location string = ${cleanResourceName}.location

`;
            }

            return outputs;
        }

        function convertSchemaToBicep(schema) {
            const resourceType = schema.properties?.type?.const || 'Microsoft.Resources/deployments';
            const resourceName = getResourceNameFromType(resourceType);
            const cleanResourceName = resourceName.replace(/[^a-zA-Z0-9]/g, '');
            const targetScope = 'resourceGroup';
            
            let bicep = `// Generated Bicep template from JSON Schema
// Resource Type: ${resourceType}
// Generated on: ${new Date().toISOString()}

targetScope = 'resourceGroup'

`;

            bicep += `metadata description = 'Bicep template for ${resourceType}'
metadata author = 'Bicep Schema Builder'
metadata version = '1.0.0'

`;

            bicep += generateAdvancedParameters(schema, resourceType, targetScope);
            bicep += generateVariables(schema, resourceType, targetScope);
            bicep += generateDetailedResource(schema, resourceType, cleanResourceName);
            bicep += generateAdvancedOutputs(schema, cleanResourceName, targetScope);

            return bicep;
        }

        function runTest() {
            const results = document.getElementById('results');
            const bicepOutput = document.getElementById('bicepOutput');
            
            results.innerHTML = '<p>Running tests...</p>';
            
            try {
                const bicep = convertSchemaToBicep(testSchema);
                bicepOutput.textContent = bicep;
                
                // Run validation tests
                const tests = [
                    {
                        name: 'No location parameter',
                        pass: !bicep.includes('param location string'),
                        details: 'Deployment resources at RG scope should not have location parameter'
                    },
                    {
                        name: 'No tags parameter',
                        pass: !bicep.includes('param tags object'),
                        details: 'Deployment resources at RG scope should not have tags parameter'
                    },
                    {
                        name: 'No location in resource',
                        pass: !bicep.includes('location: location'),
                        details: 'Deployment resource should not have location property'
                    },
                    {
                        name: 'No tags in resource',
                        pass: !bicep.includes('tags: commonTags'),
                        details: 'Deployment resource should not have tags property'
                    },
                    {
                        name: 'No commonTags variable',
                        pass: !bicep.includes('var commonTags'),
                        details: 'Should not generate commonTags variable if tags not supported'
                    },
                    {
                        name: 'No location output',
                        pass: !bicep.includes('output location string'),
                        details: 'Should not output location for deployment resources'
                    },
                    {
                        name: 'Has resourceName parameter',
                        pass: bicep.includes('param resourceName string'),
                        details: 'Should still have basic resource name parameter'
                    },
                    {
                        name: 'Has resource definition',
                        pass: bicep.includes('resource deployments'),
                        details: 'Should generate the resource definition'
                    },
                    {
                        name: 'Has resourceId output',
                        pass: bicep.includes('output resourceId string'),
                        details: 'Should still have resourceId output'
                    },
                    {
                        name: 'Correct API version',
                        pass: bicep.includes('Microsoft.Resources/deployments@2022-01-01'),
                        details: 'Should use correct API version from schema'
                    }
                ];
                
                let html = '<h3>Test Results:</h3>';
                let allPassed = true;
                
                tests.forEach(test => {
                    const statusClass = test.pass ? 'pass' : 'fail';
                    const statusText = test.pass ? '✅ PASS' : '❌ FAIL';
                    html += `
                        <div class="result ${test.pass ? '' : 'error'}">
                            <span class="${statusClass}">${statusText}</span>: ${test.name}
                            <br><small>${test.details}</small>
                        </div>
                    `;
                    if (!test.pass) allPassed = false;
                });
                
                html += `<h3 class="${allPassed ? 'pass' : 'fail'}">
                    Overall: ${allPassed ? '✅ ALL TESTS PASSED' : '❌ SOME TESTS FAILED'}
                </h3>`;
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">❌ Error: ${error.message}</div>`;
                bicepOutput.textContent = `Error generating Bicep:\n${error.stack}`;
            }
        }

        function runComparisonTest() {
            alert('This would show before/after comparison. The fix removes location and tags for Microsoft.Resources/deployments at resourceGroup scope.');
        }
    </script>
</body>
</html>
